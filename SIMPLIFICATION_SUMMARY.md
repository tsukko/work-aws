# ç°¡ç´ åŒ–ç‰ˆã®å¤‰æ›´ç‚¹

## ğŸ”§ å¤‰æ›´æ¦‚è¦

ãƒ†ã‚¹ãƒˆç’°å¢ƒå°‚ç”¨ã«ã€ä¸è¦ãªã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’å‰Šé™¤ã—ã€**æœˆé–“ã‚³ã‚¹ãƒˆã‚’ç´„ $65-70 ã‹ã‚‰ $15-20 ã«å‰Šæ¸›**ã—ã¾ã—ãŸã€‚

---

## ğŸ“‹ å‰Šé™¤ãƒ»å¤‰æ›´ã—ãŸã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

### **1ï¸âƒ£ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ç°¡ç´ åŒ–**

#### å‰Šé™¤é …ç›®
- âŒ **NAT Gateway** (Ã—2) â†’ ã‚³ã‚¹ãƒˆå‰Šæ¸›: $32/æœˆ
- âŒ **ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã‚µãƒ–ãƒãƒƒãƒˆ** (Ã—2)
- âŒ **ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒ«ãƒ¼ãƒˆãƒ†ãƒ¼ãƒ–ãƒ«** (Ã—2)

#### ç†ç”±
- ãƒ†ã‚¹ãƒˆç’°å¢ƒã§ã¯ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã‚µãƒ–ãƒãƒƒãƒˆãŒä¸è¦
- ãƒ‘ãƒ–ãƒªãƒƒã‚¯ã‚µãƒ–ãƒãƒƒãƒˆã§ååˆ†
- NAT Gateway ã®ã‚¨ã‚°ãƒ¬ã‚¹æ–™é‡‘ ($32) ã‚’å‰Šæ¸›

#### å¤‰æ›´å†…å®¹
```
å¤‰æ›´å‰: è¤‡æ•°AZ (ap-northeast-1a, 1c) + è¤‡æ•°ã‚µãƒ–ãƒãƒƒãƒˆ
å¤‰æ›´å¾Œ: å˜ä¸€AZ (ap-northeast-1a) + ãƒ‘ãƒ–ãƒªãƒƒã‚¯ã‚µãƒ–ãƒãƒƒãƒˆ 1å€‹
```

**ãƒ•ã‚¡ã‚¤ãƒ«:** `terraform/modules/network/`
- `main.tf`: NAT Gateway, ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã‚µãƒ–ãƒãƒƒãƒˆå‰Šé™¤
- `variables.tf`: `availability_zones` â†’ `availability_zone` (å˜æ•°)
- `outputs.tf`: ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã‚µãƒ–ãƒãƒƒãƒˆå‡ºåŠ›å‰Šé™¤

---

### **2ï¸âƒ£ ALB å‰Šé™¤**

#### å‰Šé™¤é …ç›®
- âŒ **Application Load Balancer** â†’ ã‚³ã‚¹ãƒˆå‰Šæ¸›: $16/æœˆ
- âŒ **ALB ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—**
- âŒ **ALBã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚°ãƒ«ãƒ¼ãƒ—**
- âŒ **ALB ãƒªã‚¹ãƒŠãƒ¼**

#### ç†ç”±
- ãƒ†ã‚¹ãƒˆç’°å¢ƒã§ã¯å¤–éƒ¨ã‚¢ã‚¯ã‚»ã‚¹ä¸è¦
- ECS ãƒ‡ãƒ—ãƒ­ã‚¤å‹•ä½œç¢ºèªã®ã¿ãŒç›®çš„
- ALB ç®¡ç†è²» $16/æœˆ ã‚’å‰Šæ¸›

#### å½±éŸ¿
- ECS ã‚µãƒ¼ãƒ“ã‚¹ã‹ã‚‰ ALB load_balancer ãƒ–ãƒ­ãƒƒã‚¯å‰Šé™¤
- ECS ã‚¿ã‚¹ã‚¯ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—ã§ `ingress 0.0.0.0/0` è¨±å¯ï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰

**ãƒ•ã‚¡ã‚¤ãƒ«:** `terraform/modules/network/`
- `main.tf`: ALB, ALB ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—, ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚°ãƒ«ãƒ¼ãƒ—å‰Šé™¤
- `outputs.tf`: ALB é–¢é€£å‡ºåŠ›å‰Šé™¤

---

### **3ï¸âƒ£ Auto Scaling å‰Šé™¤**

#### å‰Šé™¤é …ç›®
- âŒ **Auto Scaling Target**
- âŒ **CPU ãƒ™ãƒ¼ã‚¹ Auto Scaling Policy**
- âŒ **Memory ãƒ™ãƒ¼ã‚¹ Auto Scaling Policy**

#### ç†ç”±
- ãƒ†ã‚¹ãƒˆç’°å¢ƒã§ã¯å›ºå®šã‚¿ã‚¹ã‚¯æ•°ã§ååˆ†
- `desired_count = 1` ã«å›ºå®š

#### å¤‰æ›´å†…å®¹
```
å¤‰æ›´å‰: desired_count = 2, min = 1, max = 4, auto scaling enabled
å¤‰æ›´å¾Œ: desired_count = 1 (å›ºå®š)
```

**ãƒ•ã‚¡ã‚¤ãƒ«:** `terraform/modules/ecs/`
- `main.tf`: Auto Scaling ãƒªã‚½ãƒ¼ã‚¹ 3å€‹å‰Šé™¤
- `variables.tf`: `desired_count`, `min_capacity`, `max_capacity`, `cpu_target_value`, `memory_target_value` å‰Šé™¤

---

### **4ï¸âƒ£ EventBridge / CloudWatch Event å‰Šé™¤**

#### å‰Šé™¤é …ç›®
- âŒ **CloudWatch Event Rule** (CodeCommit push æ¤œå‡º)
- âŒ **CloudWatch Event Target**
- âŒ **EventBridge IAM Role**
- âŒ **EventBridge IAM Policy**

#### ç†ç”±
- ãƒ†ã‚¹ãƒˆç’°å¢ƒã§ã¯è‡ªå‹•ãƒˆãƒªã‚¬ãƒ¼ä¸è¦
- CodePipeline ã‚’æ‰‹å‹•å®Ÿè¡Œã§ååˆ†

#### ä»£æ›¿æ–¹æ³•
```bash
# æ‰‹å‹•ã§ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å®Ÿè¡Œ
aws codepipeline start-pipeline-execution \
  --name dev-pipeline
```

**ãƒ•ã‚¡ã‚¤ãƒ«:** `terraform/modules/codepipeline/`
- `main.tf`: EventBridge é–¢é€£ãƒªã‚½ãƒ¼ã‚¹ 4å€‹å‰Šé™¤
- `variables.tf`: `repository_arn` å‰Šé™¤ï¼ˆEventBridge ã§ä¸è¦ï¼‰

---

### **5ï¸âƒ£ CloudWatch Logs ä¿æŒæœŸé–“ã‚’ 0æ—¥ã«**

#### å¤‰æ›´å†…å®¹
```hcl
å¤‰æ›´å‰: retention_in_days = var.log_retention_days (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ 7)
å¤‰æ›´å¾Œ: retention_in_days = 0 (ç„¡æœŸé™ä¿æŒã€ä½†ã—æ‰‹å‹•å‰Šé™¤å‰æ)
```

#### ç†ç”±
- ãƒ†ã‚¹ãƒˆç’°å¢ƒãªã®ã§ãƒ­ã‚°ä¿å­˜ä¸è¦
- ä¿æŒè¨­å®šã‚³ã‚¹ãƒˆå‰Šæ¸›
- 0æ—¥ = ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆç„¡æœŸé™ä¿æŒï¼ˆãŸã ã—è‡ªå‹•å‰Šé™¤ãªã—ï¼‰

**ãƒ•ã‚¡ã‚¤ãƒ«:**
- `terraform/modules/ecs/main.tf`: CloudWatch Logs Group
- `terraform/modules/codepipeline/main.tf`: CodeBuild Logs Group

---

### **6ï¸âƒ£ ECS ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯è¨­å®šå¤‰æ›´**

#### å¤‰æ›´å†…å®¹
```hcl
å¤‰æ›´å‰:
  - assign_public_ip = false
  - subnets = var.private_subnet_ids
  - ALB ã«ã‚ˆã‚‹è² è·åˆ†æ•£

å¤‰æ›´å¾Œ:
  - assign_public_ip = true
  - subnets = [var.public_subnet_id]  # ãƒ‘ãƒ–ãƒªãƒƒã‚¯ã‚µãƒ–ãƒãƒƒãƒˆ
  - ALB è¨­å®šå‰Šé™¤
```

#### ç†ç”±
- ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã‚µãƒ–ãƒãƒƒãƒˆå»ƒæ­¢
- ECS ã‚¿ã‚¹ã‚¯ã‚’ãƒ‘ãƒ–ãƒªãƒƒã‚¯ã§èµ·å‹•

---

### **7ï¸âƒ£ å¤‰æ•°ãƒ•ã‚¡ã‚¤ãƒ«ç°¡ç´ åŒ–**

#### å‰Šé™¤ã—ãŸå¤‰æ•°

**`terraform/modules/ecs/variables.tf`:**
```hcl
- desired_count
- min_capacity
- max_capacity
- cpu_target_value
- memory_target_value
- log_retention_days
- private_subnet_ids
- target_group_arn
```

**`terraform/modules/network/variables.tf`:**
```hcl
- public_subnet_cidrs (ãƒªã‚¹ãƒˆ) â†’ public_subnet_cidr (æ–‡å­—åˆ—)
- private_subnet_cidrs
- availability_zones (ãƒªã‚¹ãƒˆ) â†’ availability_zone (æ–‡å­—åˆ—)
```

**`terraform/environments/dev/variables.tf`:**
```hcl
- desired_count
- min_capacity, max_capacity
- cpu_target_value, memory_target_value
- log_retention_days
- repository_arn
```

---

## ğŸ“Š ã‚³ã‚¹ãƒˆå‰Šæ¸›çµæœ

| é …ç›® | å‰Šé™¤å‰ | å‰Šé™¤å¾Œ | å‰Šæ¸›é¡ |
|---|---|---|---|
| **NAT Gateway** | $32/æœˆ | $0 | $32 |
| **ALB** | $16/æœˆ | $0 | $16 |
| **è¤‡æ•°AZ** | +$15 | $0 | $15 |
| **CloudWatch Logs** | $2/æœˆ | $0 | $2 |
| **ãã®ä»–** | $0 | $0 | $0 |
| **åˆè¨ˆ** | $65-70/æœˆ | $15-20/æœˆ | **$50-55** âœ… |

---

## âœ… å‹•ä½œç¢ºèª

ç°¡ç´ åŒ–ç‰ˆã§ã‚‚ **CodePipeline â†’ ECS ãƒ‡ãƒ—ãƒ­ã‚¤**ã¯å®Œå…¨ã«å‹•ä½œã—ã¾ã™ï¼š

```
1. CodeCommit ã¸ãƒ—ãƒƒã‚·ãƒ¥
   â†“
2. CodePipeline æ‰‹å‹•å®Ÿè¡Œ
   â†“
3. CodeBuild ã§ãƒ“ãƒ«ãƒ‰ï¼ˆDocker ã‚¤ãƒ¡ãƒ¼ã‚¸ç”Ÿæˆï¼‰
   â†“
4. ECR ã¸ãƒ—ãƒƒã‚·ãƒ¥
   â†“
5. ECS ã‚¿ã‚¹ã‚¯å®šç¾©æ›´æ–°
   â†“
6. æ–°ã‚¤ãƒ¡ãƒ¼ã‚¸ã§ ECS ã‚¿ã‚¹ã‚¯å†èµ·å‹•
```

---

## âš ï¸ åˆ¶é™äº‹é …

| æ©Ÿèƒ½ | çŠ¶æ…‹ |
|---|---|
| CodePipeline è‡ªå‹•ãƒˆãƒªã‚¬ãƒ¼ | âŒ å‰Šé™¤ï¼ˆæ‰‹å‹•å®Ÿè¡Œã«å¤‰æ›´ï¼‰ |
| ALB ã«ã‚ˆã‚‹å¤–éƒ¨ã‚¢ã‚¯ã‚»ã‚¹ | âŒ å‰Šé™¤ï¼ˆãƒ†ã‚¹ãƒˆç’°å¢ƒãªã®ã§ä¸è¦ï¼‰ |
| é«˜å¯ç”¨æ€§ï¼ˆè¤‡æ•°AZï¼‰ | âŒ å˜ä¸€AZ ã®ã¿ |
| Auto Scaling | âŒ å‰Šé™¤ï¼ˆã‚¿ã‚¹ã‚¯æ•°å›ºå®šï¼‰ |

---

## ğŸ”„ ç°¡ç´ åŒ–ç‰ˆã‹ã‚‰æœ¬ç•ªç‰ˆã¸ã®ç§»è¡Œ

æœ¬ç•ªç’°å¢ƒã§ä½¿ç”¨ã™ã‚‹å ´åˆã¯ã€ä»¥ä¸‹ã‚’è¿½åŠ ï¼š

1. **NAT Gateway ã‚’å†è¿½åŠ ** (ã‚¢ã‚¦ãƒˆãƒã‚¦ãƒ³ãƒ‰é€šä¿¡ç”¨)
2. **ALB ã‚’å†è¿½åŠ ** (å¤–éƒ¨ã‚¢ã‚¯ã‚»ã‚¹ç”¨)
3. **è¤‡æ•°AZ ã‚’æœ‰åŠ¹åŒ–** (é«˜å¯ç”¨æ€§)
4. **Auto Scaling ã‚’å†æœ‰åŠ¹åŒ–** (è² è·å¯¾å¿œ)
5. **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—ã‚’å³å¯†åŒ–**
6. **CloudWatch Logs ä¿æŒæœŸé–“ã‚’è¨­å®š**

---

## ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«å¤‰æ›´ä¸€è¦§

```
terraform/
â”œâ”€â”€ modules/
â”‚   â”œâ”€â”€ network/
â”‚   â”‚   â”œâ”€â”€ main.tf          âœï¸ ä¿®æ­£
â”‚   â”‚   â”œâ”€â”€ variables.tf      âœï¸ ä¿®æ­£
â”‚   â”‚   â””â”€â”€ outputs.tf        âœï¸ ä¿®æ­£
â”‚   â”œâ”€â”€ ecs/
â”‚   â”‚   â”œâ”€â”€ main.tf          âœï¸ ä¿®æ­£
â”‚   â”‚   â”œâ”€â”€ variables.tf      âœï¸ ä¿®æ­£
â”‚   â”‚   â””â”€â”€ outputs.tf        âœï¸ ä¿®æ­£
â”‚   â”œâ”€â”€ iam/
â”‚   â”‚   â”œâ”€â”€ main.tf          âœ“ å¤‰æ›´ãªã—
â”‚   â”‚   â”œâ”€â”€ variables.tf      âœ“ å¤‰æ›´ãªã—
â”‚   â”‚   â””â”€â”€ outputs.tf        âœ“ å¤‰æ›´ãªã—
â”‚   â””â”€â”€ codepipeline/
â”‚       â”œâ”€â”€ main.tf          âœï¸ ä¿®æ­£
â”‚       â”œâ”€â”€ variables.tf      âœï¸ ä¿®æ­£
â”‚       â””â”€â”€ outputs.tf        âœ“ å¤‰æ›´ãªã—
â”œâ”€â”€ environments/dev/
â”‚   â”œâ”€â”€ main.tf              âœï¸ ä¿®æ­£
â”‚   â”œâ”€â”€ variables.tf          âœï¸ ä¿®æ­£
â”‚   â”œâ”€â”€ outputs.tf            âœï¸ ä¿®æ­£
â”‚   â”œâ”€â”€ dev.tfvars            âœï¸ ä¿®æ­£
â”‚   â””â”€â”€ buildspec.yml         âœ“ å¤‰æ›´ãªã—
â””â”€â”€ (ãã®ä»–)                âœ“ å¤‰æ›´ãªã—
```

---

## ğŸ¯ æ´»ç”¨ã‚·ãƒŠãƒªã‚ª

### âœ… é©ã—ã¦ã„ã‚‹ç”¨é€”
- CodePipeline/ECS ãƒ‡ãƒ—ãƒ­ã‚¤ã®å‹•ä½œç¢ºèª
- CI/CD ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã®ãƒ†ã‚¹ãƒˆ
- çŸ­æœŸçš„ãªãƒ†ã‚¹ãƒˆç’°å¢ƒ
- é–‹ç™ºãƒ»æ¤œè¨¼ç’°å¢ƒ

### âŒ é©ã•ãªã„ç”¨é€”
- æœ¬ç•ªç’°å¢ƒ
- æœ¬æ ¼çš„ãªãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯å‡¦ç†
- é«˜å¯ç”¨æ€§ãŒå¿…è¦ãªç’°å¢ƒ
- 24/7 é‹ç”¨ç’°å¢ƒ

---

è©³ç´°ã‚³ã‚¹ãƒˆè¨ˆç®—ã¯ [COST_ANALYSIS.md](COST_ANALYSIS.md) ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚
