# AWS コスト計算 - テスト環境（簡素化版）

## 📊 月間予想コスト概算

### **合計: 約 $15-20/月**

---

## 詳細コスト分析

### 1️⃣ **ECS on Fargate** → $11-14/月

**仕様:**
- Fargate CPU: 256 vCPU (0.25 vCPU)
- Memory: 512 MB
- タスク数: 1つ
- 稼働時間: 24時間 × 30日

**計算:**
```
CPU コスト: 0.25 vCPU × $0.04678/vCPU時間 × 720時間 = $8.42/月
Memory コスト: 0.5 GB × $0.00521/GB時間 × 720時間 = $1.88/月

合計: 約 $10.30/月
```

### 2️⃣ **CloudWatch Logs** → Free

**理由:**
- ログ保持期間を 0日に設定
- ログは自動削除（保存期間なし）
- CloudWatch Logs の取り込みは無料（アカウント当たり5GB/月無料）

### 3️⃣ **ECR (Elastic Container Registry)** → $0.10/月

**仕様:**
- ストレージ: 10イメージ × 100MB = 約 1GB
- トランスファー: 最小限

**計算:**
```
ECR ストレージ: 1GB × $0.10/GB月 = $0.10/月
データ転送: 無視できる
```

### 4️⃣ **S3 (CodePipeline Artifacts)** → $0.50/月

**仕様:**
- ストレージ: ビルドアーティファクト 1-2GB
- バージョニング: 有効（古いバージョン保持）

**計算:**
```
ストレージ: 2GB × $0.023/GB月 = $0.05/月
リクエスト: 無視できる
```

### 5️⃣ **CodeBuild** → $3-5/月

**仕様:**
- ビルド時間: 1回 = 10-15分程度
- 実行頻度: 1日 1-2回（想定）
- マシン: BUILD_GENERAL1_SMALL

**計算:**
```
ビルド時間: 15分 × $0.005/分 = $0.075/実行
1日あたり: $0.075 × 2回 = $0.15/日
月間: $0.15 × 30日 = $4.50/月
```

### 6️⃣ **CodePipeline** → $1/月

**計算:**
```
パイプラインアクティビティ: $1/パイプライン・月
（1パイプラインのみ）
```

### 7️⃣ **VPC & ネットワーク** → 無料

**理由:**
- VPC、サブネット、ルートテーブル: すべて無料
- **NAT Gateway を削除したため** ✅ $32/月節約
- データ転送: 最小限
- インターネットゲートウェイ: 無料

### 8️⃣ **IAM** → 無料

**理由:**
- ユーザー、ロール、ポリシー: すべて無料

---

## 💰 削除による費用削減

| コンポーネント | 削除前 | 削除後 | 削減額 |
|---|---|---|---|
| NAT Gateway (×2) | $32 | $0 | **$32** ✅ |
| ALB | $16 | $0 | **$16** ✅ |
| Auto Scaling | $0 | $0 | $0 |
| EventBridge | $0 | $0 | $0 |
| 複数AZ設定 | +$15 | $0 | **$15** ✅ |
| CloudWatch Logs保持 | $2 | $0 | **$2** ✅ |
| **合計削減** | **~$65-70** | - | **~$65** ✅ |

---

## 📈 パターン別コスト

### **パターンA: ビルド1回/日**
```
ECS Fargate:        $10.30
CodeBuild (1×$0.075/日): $2.25
CodePipeline:       $1.00
ECR:                $0.10
S3:                 $0.50
合計: 約 $14.15/月
```

### **パターンB: ビルド3回/日（アクティブな開発）**
```
ECS Fargate:        $10.30
CodeBuild (3×$0.075/日): $6.75
CodePipeline:       $1.00
ECR:                $0.10
S3:                 $0.50
合計: 約 $18.65/月
```

### **パターンC: ビルド0回/日（デプロイのみ確認）**
```
ECS Fargate:        $10.30
CodeBuild:          $0.00
CodePipeline:       $1.00
ECR:                $0.10
S3:                 $0.50
合計: 約 $11.90/月
```

---

## 🔒 さらにコスト削減する方法

### **案1: Fargate の起動を一時的に停止**
```
- desired_count = 0 に変更
- テスト時のみ = 1 に変更
- 削減: $10.30/月
→ 月間 $0-5/月 のみ
```

### **案2: 1回限りの自動削除設定**
```bash
# Terraform destroy で全削除
terraform destroy -var-file="dev.tfvars"
```
- リソース完全削除後は無料
- 再度必要な時のみ apply
- 適したシナリオ: 1~2日のテスト

### **案3: Reserved Capacity 購入**
```
- Fargate Save Plans: 18~35% 割引
- 年額契約でさらに削減可能
```

---

## ⚠️ 無料枠を活用

### **AWS Free Tier (新規アカウント12ヶ月)**

| サービス | 無料枠 | 状況 |
|---|---|---|
| EC2 | 750時間/月 | ECS Fargate は対象外 ❌ |
| S3 | 5GB/月 | ✅ カバー |
| CloudWatch Logs | 5GB/月 | ✅ カバー（0日保持） |
| CodeBuild | 100分/月 | ⚠️ 部分カバー |

---

## 📋 推奨: デプロイ確認終了後のアクション

```bash
# 開発終了時は削除推奨
cd terraform/environments/dev
terraform destroy -var-file="dev.tfvars"

# 理由: ECS Fargate は停止できない
#       (desired_count = 0 でも費用発生)
#       → リソース完全削除で完全停止
```

---

## 🎯 最小コスト構成

**デプロイ確認のみが必要な場合:**

```hcl
# dev.tfvars
task_cpu    = "256"      # 最小スペック
task_memory = "512"      # 最小スペック
# → ECS: $5/月レベル

# テスト時のみ apply、完了後 destroy
# → 数日のみの運用で $5 以下
```

---

## 💡 参考: 元の構成との比較

| 項目 | 簡素化前 | 簡素化後 | 削減 |
|---|---|---|---|
| 月間コスト | $65-75 | $15-20 | **$50-55** ✅ |
| ネットワーク | NAT×2 + ALB | 無し | 66% 削減 |
| ログ保持 | 7日 | 0日 | 削減 |
| タスク数 | 2（常時） | 1 | 50% 削減 |
| Auto Scaling | 有り | 無し | 削減 |
| 高可用性 | 複数AZ | 単一AZ | 削減 |

---

## ✅ 簡素化版の特徴

| 機能 | 含まれる |
|---|---|
| ✅ ECS デプロイ動作確認 | ○ |
| ✅ CodePipeline パイプライン | ○ |
| ✅ CodeBuild ビルド | ○ |
| ✅ ECR イメージ管理 | ○ |
| ❌ 高可用性 | × |
| ❌ 外部からのアクセス | × |
| ❌ Auto Scaling | × |
| ❌ 本番環境対応 | × |

---

**テスト環境として、コスト効率と機能のバランスが最適化されています！** 💰
